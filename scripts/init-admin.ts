import 'dotenv/config'
import { drizzle } from 'drizzle-orm/node-postgres'
import * as readline from 'readline'
import * as schema from '../app/lib/db/schema'

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
})

function isEmailValid(email: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
}

const askEmail = (): Promise<string> => {
    return new Promise(resolve => {
        rl.question(
            '\nè«‹è¼¸å…¥ç®¡ç†å“¡é›»å­éƒµä»¶åœ°å€ (Please enter Admin Email) (æŒ‰ä¸‹ ^+C ä»¥é—œé–‰) (Press ^+C to exit): ',
            email => {
                if (!isEmailValid(email)) {
                    console.error(
                        'âŒ ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚(Invalid email, try again.)'
                    )
                    return resolve(askEmail())
                }
                resolve(email)
            }
        )
    })
}

async function checkAndCreateAdmin() {
    const email = await askEmail()

    const db = drizzle(process.env.DATABASE_URL!, { schema })

    try {
        // Check if admin exists
        const admin = await db.query.usersTable.findFirst({
            where: (t, { eq }) => eq(t.role, 'ADMIN'),
        })

        if (!admin) {
            console.log(
                'ç®¡ç†å“¡ä¸å­˜åœ¨ï¼Œæ­£åœ¨å»ºç«‹... (Admin does not exist. Creating...)'
            )

            // Create admin user and papa SEO
            const [newAdmin] = await db.transaction(async tx => {
                await tx.insert(schema.seosTable).values({
                    route: '/',
                    metaTitle: 'Papa',
                    metaDescription:
                        'Papa - A simple and thorough platform for modern web app.',
                    autoGenerated: true,
                })

                // TODO: Create default Post, its SEO, and tag / category

                return await tx
                    .insert(schema.usersTable)
                    .values({
                        email,
                        role: 'ADMIN',
                        status: 'ACTIVE',
                    })
                    .returning()
            })

            console.log('\nå·²å»ºç«‹ç®¡ç†å“¡ (Admin created):', newAdmin)
            console.warn(
                `\n* * * \nç®¡ç†å“¡ä½¿ç”¨è€…å·²å»ºç«‹ï¼è«‹ä½¿ç”¨ ${newAdmin.email} ç™»å…¥ã€‚æ‚¨ç¾åœ¨å¯ä»¥ä½¿ç”¨ npm run dev å•Ÿå‹•ç¨‹å¼ã€‚\n* * *\n`
            )
            console.warn(
                `\n* * * \nAdmin user created! Sign in with ${newAdmin.email}. Now, enter "npm run dev" to start the project.\n* * *\n`
            )
        } else {
            console.log(
                `ç®¡ç†å“¡ ${admin.email} å·²å­˜åœ¨ã€‚Admin ${admin.email} already exists.\n`
            )
        }
    } catch (error) {
        console.error(
            'æª¢æŸ¥/å»ºç«‹ç®¡ç†å“¡ä½¿ç”¨è€…æ™‚ç™¼ç”ŸéŒ¯èª¤ (Error checking/creating admin user):',
            error
        )
    } finally {
        console.log('\n* * *\næ­¡è¿ä½¿ç”¨ Papa ğŸ¥”âœ¨\n* * *\n')
        console.log('\n* * *\nWelcome to Papa ğŸ¥”âœ¨\n* * *\n')
        process.exit(0)
    }
}

await checkAndCreateAdmin()
